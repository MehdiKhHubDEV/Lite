<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Runner - Family Task Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .passed {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .failed {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .summary {
        background: #e7f3ff;
        padding: 20px;
        margin-top: 20px;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
      }
      .summary h2 {
        margin-top: 0;
        color: #1976d2;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      button:hover {
        background-color: #45a049;
      }
      #test-output {
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>Family Task Dashboard - Test Suite</h1>
    <p>
      This test suite validates the Badge and Task creation enhancements,
      including multi-score badge associations and task validation requirements.
    </p>

    <button onclick="runTests()">Run All Tests</button>

    <div id="test-output"></div>

    <script src="app.js"></script>
    <script>
      // Test helper to create dashboard instance
      function createTestDashboard() {
        localStorage.clear();
        return new FamilyTaskDashboard();
      }

      // Test output helper
      function logTest(message, passed) {
        const output = document.getElementById("test-output");
        const div = document.createElement("div");
        div.className = `test-result ${passed ? "passed" : "failed"}`;
        div.textContent = message;
        output.appendChild(div);
      }

      function logSection(title) {
        const output = document.getElementById("test-output");
        const section = document.createElement("div");
        section.className = "test-section";
        section.innerHTML = `<h2>${title}</h2>`;
        output.appendChild(section);
      }

      function logSummary(passed, failed, total) {
        const output = document.getElementById("test-output");
        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `
          <h2>Test Summary</h2>
          <p><strong>Total Tests:</strong> ${total}</p>
          <p><strong>Passed:</strong> ${passed} ✓</p>
          <p><strong>Failed:</strong> ${failed} ✗</p>
          <p><strong>Success Rate:</strong> ${((passed / total) * 100).toFixed(
            1
          )}%</p>
        `;
        output.appendChild(summary);
      }

      // Test Suite 1: Badge Creation with Multiple Scores
      function testBadgeCreationWithMultipleScores() {
        logSection("Test Suite 1: Badge Creation with Multiple Scores");
        let passed = 0,
          failed = 0,
          total = 0;

        // Test 1.1: Badge can be created without scores
        total++;
        try {
          const dashboard = createTestDashboard();
          const initialCount = dashboard.data.badges.length;
          const newBadge = {
            id: dashboard.getNextId("badges"),
            asset_type_id: 1,
            title: "Test Badge",
            description: "Test Description",
            score_id: null,
            icon_url: "fas fa-star",
            created_at: new Date().toISOString(),
          };
          dashboard.data.badges.push(newBadge);

          if (dashboard.data.badges.length === initialCount + 1) {
            logTest("✓ Test 1.1: Badge created without scores", true);
            passed++;
          } else {
            throw new Error("Badge count mismatch");
          }
        } catch (e) {
          logTest("✗ Test 1.1: " + e.message, false);
          failed++;
        }

        // Test 1.2: Multiple scores can be associated with a badge
        total++;
        try {
          const dashboard = createTestDashboard();
          const badgeId = dashboard.getNextId("badges");
          dashboard.data.badges.push({
            id: badgeId,
            asset_type_id: 1,
            title: "Multi-Score Badge",
            description: "Badge with multiple scores",
            score_id: null,
            icon_url: "fas fa-medal",
            created_at: new Date().toISOString(),
          });

          // Associate multiple scores
          [1, 2, 3].forEach((scoreId) => {
            const score = dashboard.data.scores.find((s) => s.id === scoreId);
            if (score) score.badge_id = badgeId;
          });

          const associated = dashboard.data.scores.filter(
            (s) => s.badge_id === badgeId
          );
          if (associated.length === 3) {
            logTest(
              "✓ Test 1.2: Multiple scores associated with badge",
              true
            );
            passed++;
          } else {
            throw new Error(`Expected 3 scores, got ${associated.length}`);
          }
        } catch (e) {
          logTest("✗ Test 1.2: " + e.message, false);
          failed++;
        }

        // Test 1.3: Badge associations can be updated
        total++;
        try {
          const dashboard = createTestDashboard();
          const badge1Id = dashboard.getNextId("badges");
          const badge2Id = badge1Id + 1;

          dashboard.data.badges.push({
            id: badge1Id,
            title: "Badge 1",
            asset_type_id: 1,
            description: "First",
            score_id: null,
            icon_url: "fas fa-star",
            created_at: new Date().toISOString(),
          });
          dashboard.data.badges.push({
            id: badge2Id,
            title: "Badge 2",
            asset_type_id: 1,
            description: "Second",
            score_id: null,
            icon_url: "fas fa-trophy",
            created_at: new Date().toISOString(),
          });

          const score = dashboard.data.scores.find((s) => s.id === 1);
          score.badge_id = badge1Id;
          score.badge_id = badge2Id; // Update

          if (score.badge_id === badge2Id) {
            logTest("✓ Test 1.3: Badge associations updated", true);
            passed++;
          } else {
            throw new Error("Association not updated");
          }
        } catch (e) {
          logTest("✗ Test 1.3: " + e.message, false);
          failed++;
        }

        return { passed, failed, total };
      }

      // Test Suite 2: Task Creation Validation
      function testTaskCreationValidation() {
        logSection("Test Suite 2: Task Creation Validation");
        let passed = 0,
          failed = 0,
          total = 0;

        // Test 2.1: Task with only Badge is valid
        total++;
        try {
          const task = { badge_id: 1, score_id: null };
          const isValid = task.badge_id !== null || task.score_id !== null;
          if (isValid) {
            logTest("✓ Test 2.1: Task with only Badge is valid", true);
            passed++;
          } else {
            throw new Error("Should be valid");
          }
        } catch (e) {
          logTest("✗ Test 2.1: " + e.message, false);
          failed++;
        }

        // Test 2.2: Task with only Score is valid
        total++;
        try {
          const task = { badge_id: null, score_id: 1 };
          const isValid = task.badge_id !== null || task.score_id !== null;
          if (isValid) {
            logTest("✓ Test 2.2: Task with only Score is valid", true);
            passed++;
          } else {
            throw new Error("Should be valid");
          }
        } catch (e) {
          logTest("✗ Test 2.2: " + e.message, false);
          failed++;
        }

        // Test 2.3: Task with both Badge and Score is valid
        total++;
        try {
          const task = { badge_id: 1, score_id: 1 };
          const isValid = task.badge_id !== null || task.score_id !== null;
          if (isValid) {
            logTest("✓ Test 2.3: Task with both is valid", true);
            passed++;
          } else {
            throw new Error("Should be valid");
          }
        } catch (e) {
          logTest("✗ Test 2.3: " + e.message, false);
          failed++;
        }

        // Test 2.4: Task with neither Badge nor Score is INVALID
        total++;
        try {
          const task = { badge_id: null, score_id: null };
          const isValid = task.badge_id !== null || task.score_id !== null;
          if (!isValid) {
            logTest("✓ Test 2.4: Task with neither is invalid", true);
            passed++;
          } else {
            throw new Error("Should be invalid");
          }
        } catch (e) {
          logTest("✗ Test 2.4: " + e.message, false);
          failed++;
        }

        // Test 2.5: Validation prevents creating invalid tasks
        total++;
        try {
          const dashboard = createTestDashboard();
          const initialCount = dashboard.data.tasks.length;

          // Simulate validation check before adding
          const proposedTask = {
            badge_id: null,
            score_id: null,
            title: "Invalid",
            description: "Should not be added",
          };

          const isValid =
            proposedTask.badge_id !== null || proposedTask.score_id !== null;

          // Only add if valid
          if (isValid) {
            dashboard.data.tasks.push(proposedTask);
          }

          const finalCount = dashboard.data.tasks.length;
          if (finalCount === initialCount) {
            logTest("✓ Test 2.5: Validation prevents invalid tasks", true);
            passed++;
          } else {
            throw new Error("Invalid task was added");
          }
        } catch (e) {
          logTest("✗ Test 2.5: " + e.message, false);
          failed++;
        }

        return { passed, failed, total };
      }

      // Test Suite 3: Integration Tests
      function testIntegration() {
        logSection("Test Suite 3: Integration Tests");
        let passed = 0,
          failed = 0,
          total = 0;

        // Test 3.1: Badge with scores can be used in tasks
        total++;
        try {
          const dashboard = createTestDashboard();
          const badgeId = dashboard.getNextId("badges");
          const scoreId = 1;

          dashboard.data.badges.push({
            id: badgeId,
            asset_type_id: 1,
            title: "Integration Badge",
            description: "Test",
            score_id: scoreId,
            icon_url: "fas fa-star",
            created_at: new Date().toISOString(),
          });

          const score = dashboard.data.scores.find((s) => s.id === scoreId);
          if (score) score.badge_id = badgeId;

          const taskId = dashboard.getNextId("tasks");
          dashboard.data.tasks.push({
            id: taskId,
            title: "Integration Task",
            description: "Test task",
            badge_id: badgeId,
            score_id: scoreId,
            created_at: new Date().toISOString(),
          });

          const task = dashboard.data.tasks.find((t) => t.id === taskId);
          if (task && task.badge_id === badgeId && task.score_id === scoreId) {
            logTest("✓ Test 3.1: Badge with scores used in tasks", true);
            passed++;
          } else {
            throw new Error("Integration failed");
          }
        } catch (e) {
          logTest("✗ Test 3.1: " + e.message, false);
          failed++;
        }

        // Test 3.2: Task validation maintains data integrity
        total++;
        try {
          const dashboard = createTestDashboard();
          const validTasks = dashboard.data.tasks.filter(
            (t) => t.badge_id !== null || t.score_id !== null
          );

          if (validTasks.length === dashboard.data.tasks.length) {
            logTest("✓ Test 3.2: All tasks pass validation", true);
            passed++;
          } else {
            throw new Error(
              `${
                dashboard.data.tasks.length - validTasks.length
              } invalid tasks found`
            );
          }
        } catch (e) {
          logTest("✗ Test 3.2: " + e.message, false);
          failed++;
        }

        return { passed, failed, total };
      }

      // Main test runner
      function runTests() {
        const output = document.getElementById("test-output");
        output.innerHTML = "";

        const suite1 = testBadgeCreationWithMultipleScores();
        const suite2 = testTaskCreationValidation();
        const suite3 = testIntegration();

        const totalPassed = suite1.passed + suite2.passed + suite3.passed;
        const totalFailed = suite1.failed + suite2.failed + suite3.failed;
        const totalTests = suite1.total + suite2.total + suite3.total;

        logSummary(totalPassed, totalFailed, totalTests);
      }
    </script>
  </body>
</html>
